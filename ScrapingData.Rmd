---
title: "Final project"
author: "Jake Clauson"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(dplyr) # For data manipulation
library(stringr) # For string operations
library(purrr) # for functional programming
library(rvest) # For Web Scraping
library(readr) # For Reading/Writing csvs
library(ggplot2) # For plotting/visualization

create_songlyrics_url <- function(artist, title) {      # Function to create SongLyrics.com URL given artist and title
  clean <- function(x) {                                # nested function to clean strings
    x %>%
      tolower() %>%                             # Convert to lowercase
      str_replace_all("&", "and") %>%           # replace & with and
      str_replace_all("[^a-z0-9 ]", "") %>%     # remove all non alphabetical/numeric charachters
      str_trim() %>%                            # remove leading/ trailing whitespaces
      str_replace_all(" +", "-")                # replace spaces with dashes for url format
  }
  
  title_main <- str_split(title, "/", simplify = TRUE)[1] %>% str_trim() # Some titles contain ("/"), keep only the first part
  artist_clean <- clean(artist)         # Clean artist strings using the clean() function
  title_clean <- clean(title_main)      # Clean title strings using the clean() function
  # Construct and return full URL
  paste0("https://www.songlyrics.com/", artist_clean, "/", title_clean, "-lyrics/")       # Construct and return the full url 
}

# This Function scrapes lyric text from a SongLyrics.com page
get_lyrics <- function(url) {
  tryCatch({
    page <- read_html(url)               # Read HTML of the page
    lyrics <- page %>%
      html_node(".songLyricsV14") %>%    # Locate lyrics HTML node
      html_text(trim = TRUE)             # Extract and trim text
    return(lyrics)                       # Return the lyrics string
  }, error = function(e) {
    return(NA)                           # Return N.A on failure
  })
}

safe_get_lyrics <- safely(get_lyrics, otherwise = NA)   # Safely wrap the get_lyrics function so errors don't crash the program

# This function Cleans the Title and Artist columns to make sure they are valid UTF-8 strings
clean_titles_artists <- function(df) {
  df %>%
    mutate(
      Title = iconv(as.character(Title), to = "UTF-8", sub = ""),      # Ensures Title is UTF-8
      Artist = iconv(as.character(Artist), to = "UTF-8", sub = "")     # Ensures Artist is UTF-8
    )
}

# This function adds lyrics to the dataframe of songs (Main Function)
get_songs_with_lyrics <- function(df) {
  df %>%
    mutate(
      url = map2_chr(Artist, Title, create_songlyrics_url),    # Creates URL's for each title-artist pair
      lyrics_result = map(url, safe_get_lyrics),               # Safely scrapes lyrics for each URL
      lyrics = map_chr(lyrics_result, ~ .x$result)             # Extract only the lyrics from the result          
    ) %>%
    select(-lyrics_result)                                     # Drops the lyrics_result column (not needed)
}



```

```{r}
songs <- read.csv("/Users/jclauson/Downloads/AllSongsData.csv") # Billboard top songs (Elliot replace with your dataset)
```

```{r, eval=FALSE}

# These functions filter songs in their respective decades from our Billboard top songs dataset.
# Only filter from 1946 to 2019 because billboard released their top 100 in 1946 and www.songlyrics.com only has lyrics up to 2019

songs_1940 <- songs %>% filter(Year >= 1946 & Year <= 1949) %>% clean_titles_artists()  # Filter songs from the late 1940s (1946–1949) and clean the Title and Artist
songs_1950 <- songs %>% filter(Year >= 1950 & Year <= 1959) %>% clean_titles_artists()  # Filter songs from the 1950s (1950–1959) and clean the Title and Artist 
songs_1960 <- songs %>% filter(Year >= 1960 & Year <= 1969) %>% clean_titles_artists()  # Filter songs from the 1960s (1960–1969) and clean the Title and Artist 
songs_1970 <- songs %>% filter(Year >= 1970 & Year <= 1979) %>% clean_titles_artists()  # Filter songs from the 1970s (1970–1979) and clean the Title and Artist 
songs_1980 <- songs %>% filter(Year >= 1980 & Year <= 1989) %>% clean_titles_artists()  # Filter songs from the 1980s (1980–1989) and clean the Title and Artist 
songs_1990 <- songs %>% filter(Year >= 1990 & Year <= 1999) %>% clean_titles_artists()  # Filter songs from the 1990s (1990–1999) and clean the Title and Artist 
songs_2000 <- songs %>% filter(Year >= 2000 & Year <= 2009) %>% clean_titles_artists()  # Filter songs from the 2000s (2000–2009) and clean the Title and Artist 
songs_2010 <- songs %>% filter(Year >= 2010 & Year <= 2019) %>% clean_titles_artists()  # Filter songs from the 2010s (2010–2019) and clean the Title and Artist 

```

```{r, eval=FALSE}
# These functions scrape lyrics for each using the get_songs_with_lyrics function on the decades datasets and return a dataframe with lyrics, artist, song for each decade

songs_1940_lyrics <- get_songs_with_lyrics(songs_1940) # Scrape song lyrics from the 1940's
songs_1950_lyrics <- get_songs_with_lyrics(songs_1950) # Scrape song lyrics from the 1950's
songs_1960_lyrics <- get_songs_with_lyrics(songs_1960) # Scrape song lyrics from the 1960's
songs_1970_lyrics <- get_songs_with_lyrics(songs_1970) # Scrape song lyrics from the 1970's
songs_1980_lyrics <- get_songs_with_lyrics(songs_1980) # Scrape song lyrics from the 1980's
songs_1990_lyrics <- get_songs_with_lyrics(songs_1990) # Scrape song lyrics from the 1990's
songs_2000_lyrics <-  get_songs_with_lyrics(songs_2000) # Scrape song lyrics from the 2000's
songs_2010_lyrics <- get_songs_with_lyrics(songs_2010) # Scrape song lyrics from the 2010's 
```

```{r, eval=FALSE}
# Combine each decade datafram with lyrics into one dataframe
all_songs_lyrics <- rbind(songs_1940_lyrics, songs_1950_lyrics, songs_1960_lyrics, songs_1970_lyrics, songs_1980_lyrics, songs_1990_lyrics, songs_2000_lyrics, songs_2010_lyrics)

```

```{r, eval=FALSE}
# This function cleans the all_song_lyrics dataset for undesirable values

combined_all_songs_lyrics <- all_songs_lyrics[ 
  !is.na(all_songs_lyrics$lyrics) & 
  # Deletes rows with N.A in lyrics column
  !grepl("^We do not have the lyrics for", all_songs_lyrics$lyrics, ignore.case = TRUE) & 
  # Deletes rows that www.songlyrics.com does not have lyrics for
  !grepl("^\\[?Instrumental\\]?$", all_songs_lyrics$lyrics, ignore.case = TRUE), 
  # Deletes rows containing instrumental songs
]


```

```{r}
combined_all_songs_lyrics <- read.csv("/Users/jclauson/STAT 345/STAT345-S25/combined_all_songs_lyrics.csv") # Elliot include the path to your csv
```

```{r,warning=FALSE, message=FALSE}

# This function counts how many times the title appears in the lyrics for each song
all_songs_lyrics <- combined_all_songs_lyrics %>%
  mutate(
    title_lower = tolower(Title), 
    # converts song titles to lowercase (make comparison to lyrics not case-sensitive)
    lyrics_lower = tolower(lyrics),
    # converts song lyrics to lowercase
    title_clean = str_replace_all(title_lower, "[^a-z0-9 ]", ""),
    # removes special characters from title
    title_in_lyrics_count = str_count(lyrics_lower, paste0("\\b", title_clean, "\\b")),
    # count how often cleaned title appears in lyrics
    mentions_per_sec = title_in_lyrics_count / duration_sec
    # Calculate title mentions per second using the duration_sec variable
    )


model <- lm(title_in_lyrics_count ~ Year, data = all_songs_lyrics)
# Fit linear model to get slope (How title mentions change over time)
slope <- round(coef(model)["Year"], 4) 
# extract and round the slope to 4 decimal places

# Plot with slope annotated
p6 <- ggplot(all_songs_lyrics, aes(x = Year, y = title_in_lyrics_count)) +
  geom_point(alpha = 0.6, color = "black", size = .6) + # Plot points for each value
  geom_smooth(method = "lm", color = "red") +           # Add regression line
  annotate(
    "text",
    x = min(all_songs_lyrics$Year, na.rm = TRUE) ,  # Place annotation on left edge of plot   
    y = max(all_songs_lyrics$title_in_lyrics_count, na.rm = TRUE), # Place on the top of plot
    label = paste("Slope:", slope), # Show the slope value
    hjust = 0,
    size = 4, 
    color = "red"
  ) +
  labs(
    title = "Title Mentions in Song Lyrics (Each Song)",      # Plot title
    x = "Year",                                               # X-axis label
    y = "Number of Times Title Appears in Lyrics"             # Y-axis label
  ) +
  theme_minimal()                                             # Use a clean minimal theme

ggsave("repetitive_lines_frequency.png", plot = p6, width = 8, height = 5, dpi = 300, bg = "white")
```

```{r, warning=FALSE, message=FALSE}

model <- lm(mentions_per_sec ~ Year, data = all_songs_lyrics)
#  Fit a linear model to get slope (How title mentions per second change over time)
slope <- round(coef(model)["Year"], 4)
#  Extract and round the slope to 4 decimal places

#  Plot the mentions per second
p7 <- ggplot(all_songs_lyrics, aes(x = Year, y = mentions_per_sec)) + 
  geom_point(alpha = 0.6,size = .6, color = "black", size = 2) + # Plot points for each value
  geom_smooth(method = "lm", color = "red") +                    # Add regression line
  annotate(
    "text",
    x = min(all_songs_lyrics$Year, na.rm = TRUE),   # Place annotation on left edge of plot
    y = max(all_songs_lyrics$mentions_per_sec, na.rm = TRUE), # Place on the top of plot
    label = paste("Slope:", slope),   # Show the slope value
    hjust = 0,
    size = 4,
    color = "red"
  ) +
  labs(
    title = "Title Mentions (Per Second) in Lyrics by Year",    # Plot title
    x = "Year",                                                 # X-axis Label
    y = "Mentions Per Second"                                   # Y-axis Label
  ) +
  theme_minimal()                                               # Use a clean minimal theme

ggsave("repetitive_title_frequency.png", plot = p7, width = 8, height = 5, dpi = 300, bg = "white")
```
